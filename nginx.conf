server {
    listen 80;
    server_name localhost;
    client_max_body_size 10M;  # allow image uploads up to ~7MB base64

    # ── HTML pages — never cache; always revalidate ──────────────────────────
    # This prevents Cloudflare, nginx proxy manager, and browser caches from
    # serving stale HTML (which in turn loads stale JS/CSS bundles).
    location ~* \.html$ {
        root /usr/share/nginx/html;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
        try_files $uri $uri/ /index.html;
    }

    # ── JS / CSS — revalidate on every request ───────────────────────────────
    # max-age=0 + must-revalidate means the browser always asks "is this still
    # fresh?" via ETag/Last-Modified before using the cached copy.
    location ~* \.(js|css)$ {
        root /usr/share/nginx/html;
        add_header Cache-Control "public, max-age=0, must-revalidate";
        try_files $uri =404;
    }

    # ── Icons / images / fonts — cache for 7 days ────────────────────────────
    # These are truly static and won't change without a file rename.
    location ~* \.(png|svg|ico|jpg|jpeg|gif|webp|woff2|woff|ttf)$ {
        root /usr/share/nginx/html;
        add_header Cache-Control "public, max-age=604800, immutable";
        try_files $uri =404;
    }

    # ── Everything else ──────────────────────────────────────────────────────
    location / {
        root /usr/share/nginx/html;
        index index.html;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
        try_files $uri $uri/ /index.html;
    }

    location /api/ {
        proxy_pass http://backend:8009/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header Authorization $http_authorization;
        proxy_connect_timeout 30s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
        send_timeout 600s;
        proxy_cache_bypass $http_upgrade;
        proxy_intercept_errors off;
    }
}